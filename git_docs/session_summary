#!/usr/bin/env bash
#
# session-summary - Generate automatic session statistics
# Usage: session-summary [date] [folder]
#
# Helps automate the boring parts of session documentation by collecting:
# - Files created/modified today
# - File counts and sizes
# - Recent commands (from history)
# - Time stamps
#
# Supports multiple sessions per day - appends with timestamps!
#
# You still need to add: decisions, learnings, reflection (the human parts!)

set -euo pipefail

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get date (default: today)
DATE="${1:-$(date +%Y-%m-%d)}"
DATE_FORMATTED=$(date -j -f "%Y-%m-%d" "$DATE" "+%Y_%m_%d" 2>/dev/null || echo "$DATE" | tr '-' '_')
TIMESTAMP=$(date "+%H:%M:%S")
TIMESTAMP_READABLE=$(date "+%I:%M %p")

# Get folder (default: workspace root)
WORKSPACE="${2:-/Users/mac/Documents/Local Vault}"

# Session output file
SESSION_FILE="$WORKSPACE/sessions/session_${DATE_FORMATTED}.md"

# Create sessions directory if it doesn't exist
mkdir -p "$WORKSPACE/sessions"

# Check if this is a new session file or append to existing
if [[ -f "$SESSION_FILE" ]]; then
  APPEND_MODE=true
  echo -e "${CYAN}ğŸ“ Appending to existing session file${NC}"
else
  APPEND_MODE=false
  echo -e "${CYAN}ğŸ“ Creating new session file${NC}"
fi

echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘       Session Summary Generator                â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Date:${NC} $DATE"
echo -e "${BLUE}Time:${NC} $TIMESTAMP_READABLE"
echo -e "${BLUE}Workspace:${NC} $WORKSPACE"
echo -e "${BLUE}Output:${NC} $SESSION_FILE"
echo ""

# Prepare output - either create new or append
if [[ "$APPEND_MODE" == "false" ]]; then
  # New file - add header
  cat > "$SESSION_FILE" << EOF
# Session Log: $DATE

---

EOF
fi

# Append session section with timestamp
cat >> "$SESSION_FILE" << EOF

## Session: $TIMESTAMP_READABLE

EOF

# Function to append section to file
append_section() {
  cat >> "$SESSION_FILE"
}

# Find files created/modified today
echo -e "${GREEN}ğŸ“ Analyzing Files...${NC}"

{
  echo "### ğŸ“ Files Created/Modified"
  echo ""
  echo "**Created Today:**"
  echo ""
} | append_section

# Files created today
find "$WORKSPACE" \
  -type f \
  -not -path "*/node_modules/*" \
  -not -path "*/.obsidian/*" \
  -not -path "*/archive/*" \
  -not -path "*/.DS_Store" \
  -newermt "$DATE 00:00:00" ! -newermt "$DATE 23:59:59" \
  2>/dev/null | \
  while IFS= read -r file; do
    size=$(ls -lh "$file" 2>/dev/null | awk '{print $5}')
    echo "- \`$file\` ($size)"
  done | \
  sort -u | \
  head -20 | append_section

# Count by type
{
  echo ""
  echo "**File Counts by Type:**"
  echo ""
} | append_section

find "$WORKSPACE" \
  -type f \
  -newermt "$DATE 00:00:00" ! -newermt "$DATE 23:59:59" \
  -not -path "*/node_modules/*" \
  -not -path "*/.obsidian/*" 2>/dev/null | \
  while IFS= read -r file; do
    basename "$file"
  done | \
  grep '\.' | \
  sed 's/.*\.//' | \
  sort | uniq -c | \
  awk '{print "- " $2 ": **" $1 " files**"}' | \
  head -10 | append_section

# Recent folders touched
echo -e "${GREEN}ğŸ“‚ Analyzing Folders...${NC}"

{
  echo ""
  echo "### ğŸ“‚ Folders Modified"
  echo ""
} | append_section

find "$WORKSPACE" \
  -type d \
  -maxdepth 2 \
  -not -path "*/node_modules/*" \
  -not -path "*/.obsidian/*" \
  -newermt "$DATE 00:00:00" \
  2>/dev/null | \
  while IFS= read -r dir; do
    echo "- \`$dir\`"
  done | \
  sort -u | \
  head -10 | append_section

# Workspace stats
echo -e "${GREEN}ğŸ“Š Gathering Statistics...${NC}"

{
  echo ""
  echo "### ğŸ“Š Workspace Statistics"
  echo ""
} | append_section

# Count markdown files
md_count=$(find "$WORKSPACE" -name "*.md" -type f ! -path "*/node_modules/*" ! -path "*/.obsidian/*" 2>/dev/null | wc -l | tr -d ' ')
echo "- Total .md files: **$md_count**" | append_section

# Count scripts
script_count=$(find "$WORKSPACE" -type f -perm +111 ! -path "*/node_modules/*" ! -path "*/.obsidian/*" ! -name "*.app" 2>/dev/null | wc -l | tr -d ' ')
echo "- Executable scripts: **$script_count**" | append_section

# Sessions folder
if [[ -d "$WORKSPACE/sessions" ]]; then
  session_count=$(ls "$WORKSPACE/sessions" 2>/dev/null | wc -l | tr -d ' ')
  echo "- Session notes: **$session_count**" | append_section
fi

# knowledge_base_setup folder
if [[ -d "$WORKSPACE/knowledge_base_setup" ]]; then
  kb_count=$(find "$WORKSPACE/knowledge_base_setup" -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
  echo "- Knowledge base docs: **$kb_count**" | append_section
fi

# Projects
if [[ -d "$WORKSPACE/Projects" ]] || [[ -d "$WORKSPACE/projects" ]]; then
  proj_dir="$WORKSPACE/Projects"
  [[ -d "$WORKSPACE/projects" ]] && proj_dir="$WORKSPACE/projects"

  project_count=$(find "$proj_dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
  echo "- Active projects: **$project_count**" | append_section
fi

# Git status (if in git repo)
echo -e "${GREEN}ğŸ“ Checking Git...${NC}"

{
  echo ""
  echo "### ğŸ“ Git Status"
  echo ""
} | append_section

if git -C "$WORKSPACE" rev-parse --git-dir > /dev/null 2>&1; then
  {
    echo "**Changes:**"
    echo ""
    echo '```'
  } | append_section

  cd "$WORKSPACE"
  git status --short 2>/dev/null | head -20 | append_section

  {
    echo '```'
    echo ""
    echo "**Recent commits today:**"
    echo ""
  } | append_section

  commit_log=$(git log --since="$DATE 00:00:00" --until="$DATE 23:59:59" --oneline 2>/dev/null | head -10)

  if [[ -n "$commit_log" ]]; then
    echo '```' | append_section
    echo "$commit_log" | append_section
    echo '```' | append_section
  else
    echo "_No commits today_" | append_section
  fi
else
  echo "_Not a git repository_" | append_section
fi

# Recent shell history
echo -e "${GREEN}ğŸ“œ Extracting Recent Commands...${NC}"

{
  echo ""
  echo "### ğŸ“œ Recent Commands (Last 20)"
  echo ""
  echo '```bash'
} | append_section

# Try to get commands from today
if [[ -f ~/.zsh_history ]]; then
  tail -20 ~/.zsh_history 2>/dev/null | \
    sed 's/^.*;//' | \
    grep -v "^ls\|^cd\|^pwd\|^clear" | \
    head -20 | append_section || echo "# (Could not read history)" | append_section
elif [[ -f ~/.bash_history ]]; then
  tail -20 ~/.bash_history 2>/dev/null | \
    grep -v "^ls\|^cd\|^pwd\|^clear" | \
    head -20 | append_section || echo "# (Could not read history)" | append_section
else
  echo "# (No history file found)" | append_section
fi

{
  echo '```'
  echo ""
  echo "---"
  echo ""
  echo "### âœï¸ Manual Notes"
  echo ""
  echo "**ğŸ¯ Goals:**"
  echo "- "
  echo ""
  echo "**âœ… Completed:**"
  echo "- "
  echo ""
  echo "**ğŸ’¡ Key Learnings:**"
  echo "- "
  echo ""
  echo "**ğŸ¤” Decisions Made:**"
  echo "- "
  echo ""
  echo "**ğŸ“‹ Next Steps:**"
  echo "- "
  echo ""
  echo "**ğŸ“ Reflection:**"
  echo "- "
  echo ""
} | append_section

# Success message
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo -e "${GREEN}âœ… Session summary saved!${NC}"
echo ""
echo -e "  ğŸ“„ File: ${BLUE}$SESSION_FILE${NC}"
echo ""
if [[ "$APPEND_MODE" == "true" ]]; then
  echo -e "  ${CYAN}â„¹ï¸  Appended new session at $TIMESTAMP_READABLE${NC}"
else
  echo -e "  ${CYAN}â„¹ï¸  Created new session file${NC}"
fi
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  1. Open the file and fill in the 'Manual Notes' section"
echo "  2. Add your goals, completions, learnings, and reflections"
echo ""
echo -e "${CYAN}Tips:${NC}"
echo "  - Run multiple times per day to track different work sessions"
echo "  - Each run appends a new timestamped section"
echo "  - Use: ${YELLOW}session-summary 2025-11-04${NC} for a specific date"
echo ""
