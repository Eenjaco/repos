#!/usr/bin/env bash
# mdcon-batch - Batch convert multiple PDFs to Markdown
# Usage: mdcon-batch

set -eo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_success() {
    echo -e "${CYAN}[SUCCESS]${NC} $1"
}

# Main batch processing
main() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘      mdcon-batch - Batch PDF Converter        â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # Get input folder
    echo -e "${YELLOW}Drag & drop the folder containing PDFs:${NC}"
    read -r input_folder
    input_folder=$(echo "$input_folder" | xargs)

    if [[ ! -d "$input_folder" ]]; then
        log_error "Folder not found: $input_folder"
        exit 1
    fi

    # Get output folder
    echo ""
    echo -e "${YELLOW}Drag & drop the output folder for markdown files:${NC}"
    echo -e "${YELLOW}(Or press Enter to use same folder as PDFs)${NC}"
    read -r output_folder
    output_folder=$(echo "$output_folder" | xargs)

    if [[ -z "$output_folder" ]]; then
        output_folder="$input_folder"
    fi

    if [[ ! -d "$output_folder" ]]; then
        log_error "Output folder not found: $output_folder"
        exit 1
    fi

    echo ""
    log_info "Input folder:  $input_folder"
    log_info "Output folder: $output_folder"
    echo ""

    # Count PDF files
    local pdf_count
    pdf_count=$(find "$input_folder" -maxdepth 1 -type f \( -iname "*.pdf" \) | wc -l | tr -d ' ')

    if [ "$pdf_count" -eq 0 ]; then
        log_error "No PDF files found in $input_folder"
        exit 1
    fi

    log_info "Found $pdf_count PDF files to convert"
    echo ""

    # Confirm
    echo -e "${YELLOW}Ready to convert $pdf_count PDFs?${NC}"
    read -p "Press Enter to continue (or Ctrl+C to cancel)..."
    echo ""

    # Track progress
    local processed=0
    local succeeded=0
    local failed=0
    local skipped=0
    local start_time=$(date +%s)

    # Get list of existing markdown files before processing
    local existing_md_count
    existing_md_count=$(find "$output_folder" -maxdepth 1 -type f -name "*.md" | wc -l | tr -d ' ')

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Starting batch conversion..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    # Process each PDF
    find "$input_folder" -maxdepth 1 -type f \( -iname "*.pdf" \) | sort | while IFS= read -r pdf_file; do
        processed=$((processed + 1))
        local filename=$(basename "$pdf_file")
        local basename="${filename%.pdf}"
        local output_file="$output_folder/${basename}.md"

        echo -e "${BLUE}[$processed/$pdf_count]${NC} Processing: $filename"

        # Check if output already exists
        if [[ -f "$output_file" ]]; then
            echo -e "${YELLOW}  â†’ Already exists, skipping${NC}"
            skipped=$((skipped + 1))
            echo ""
            continue
        fi

        # Run mdcon on this file (non-interactive mode)
        if mdcon "$pdf_file" "$output_file" 2>&1 | grep -q "âœ“\|Cleaned\|Complete"; then
            echo -e "${GREEN}  âœ“ Converted successfully${NC}"
            succeeded=$((succeeded + 1))
        else
            echo -e "${RED}  âœ— Conversion failed${NC}"
            failed=$((failed + 1))
        fi

        echo ""
    done

    # Get final markdown count
    local final_md_count
    final_md_count=$(find "$output_folder" -maxdepth 1 -type f -name "*.md" | wc -l | tr -d ' ')
    local new_md_count=$((final_md_count - existing_md_count))

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    # Summary
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Batch Conversion Complete!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ“Š Summary:"
    echo "  Total PDFs found:     $pdf_count"
    echo "  Successfully converted: ${GREEN}$succeeded${NC}"
    echo "  Failed:               ${RED}$failed${NC}"
    echo "  Skipped (existing):   ${YELLOW}$skipped${NC}"
    echo ""
    echo "ğŸ“ Results:"
    echo "  MD files before: $existing_md_count"
    echo "  MD files after:  $final_md_count"
    echo "  New MD files:    ${GREEN}$new_md_count${NC}"
    echo ""
    echo "â±ï¸  Time taken: ${duration}s"
    echo ""
    echo "Output location: $output_folder"
    echo ""

    if [ "$failed" -gt 0 ]; then
        log_warn "Some files failed to convert. Check the output above for details."
    else
        log_success "All files converted successfully! ğŸ‰"
    fi

    echo ""
    echo "Press any key to exit..."
    read -n 1 -s
}

main
